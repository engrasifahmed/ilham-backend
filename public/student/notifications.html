<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications - ILHAM Student Portal</title>
    <link rel="stylesheet" href="layout.css">
    <style>
        .notif-card {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notif-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.05);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 32px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-left">
            <div class="logo">
                <img src="/Logo.png" alt="ILHAM" style="height: 40px;">
            </div>
        </div>
        <div class="nav-right">
            <div class="profile-section" id="profile-section">
                <div class="profile-avatar" id="profile-avatar">S</div>
                <span id="student-name">Student</span>
            </div>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-section">
            <div class="sidebar-section-title">Main</div>
            <ul class="sidebar-menu">
                <li class="sidebar-item">
                    <a href="dashboard.html" class="sidebar-link">
                        <span>Dashboard</span>
                    </a>
                </li>
            </ul>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">IELTS</div>
            <ul class="sidebar-menu">
                <li class="sidebar-item">
                    <a href="ielts-materials.html" class="sidebar-link">
                        <span>Materials</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="ielts-courses.html" class="sidebar-link">
                        <span>Courses</span>
                    </a>
                </li>
                
                <li class="sidebar-item">
                    <a href="ielts-mock.html" class="sidebar-link">
                        <span>Mock Tests</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="ielts-results.html" class="sidebar-link">
                        <span>Results</span>
                    </a>
                </li>
            </ul>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">Applications</div>
            <ul class="sidebar-menu">
                <li class="sidebar-item">
                    <a href="applications.html" class="sidebar-link">
                        <span>My Applications</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="universities.html" class="sidebar-link">
                        <span>Universities</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="application-new.html" class="sidebar-link">
                        <span>New Application</span>
                    </a>
                </li>
            </ul>
        </div>

        <div class="sidebar-section">
            <div class="sidebar-section-title">Account</div>
            <ul class="sidebar-menu">
                <li class="sidebar-item">
                    <a href="invoices.html" class="sidebar-link">
                        <span>Invoices</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="documents.html" class="sidebar-link">
                        <span>Documents</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="profile.html" class="sidebar-link">
                        <span>Profile</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="notifications.html" class="sidebar-link active">
                        <span>Notifications</span>
                    </a>
                </li>
            </ul>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="page-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 class="page-title">Notifications</h1>
                    <p class="page-subtitle">Stay updated with your applications and courses</p>
                </div>
                <button class="btn btn-secondary" onclick="markAllRead()">
                    Mark All as Read
                </button>
            </div>
        </div>

        <!-- Filter Tabs -->
        <div class="card">
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-primary" style="padding: 10px 20px;" onclick="filterNotifs('all')">All</button>
                <button class="btn btn-secondary" style="padding: 10px 20px;"
                    onclick="filterNotifs('unread')">Unread</button>
                <button class="btn btn-secondary" style="padding: 10px 20px;"
                    onclick="filterNotifs('applications')">Applications</button>
                <button class="btn btn-secondary" style="padding: 10px 20px;"
                    onclick="filterNotifs('payments')">Payments</button>
                <button class="btn btn-secondary" style="padding: 10px 20px;"
                    onclick="filterNotifs('ielts')">IELTS</button>
            </div>
        </div>

        <!-- Notifications List -->
        <div id="notifications-container">
            <!-- Sample Notifications -->
            <div class="card"
                style="background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3B82F6; cursor: pointer;"
                onclick="readNotification(1)">
                <div style="display: flex; gap: 16px;">
                    <div style="font-size: 32px;">📝</div>
                    <div style="flex: 1;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <h3 style="font-size: 16px; font-weight: 600;">Application Status Updated</h3>
                            <span style="font-size: 12px; color: rgba(255,255,255,0.5);">2 hours ago</span>
                        </div>
                        <p style="color: rgba(255,255,255,0.8); font-size: 14px;">
                            Your application to University of London has been updated to "Under Review"
                        </p>
                    </div>
                </div>
            </div>

            <div class="card" style="cursor: pointer; opacity: 0.7;" onclick="readNotification(2)">
                <div style="display: flex; gap: 16px;">
                    <div style="font-size: 32px;">💰</div>
                    <div style="flex: 1;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <h3 style="font-size: 16px; font-weight: 600;">Payment Reminder</h3>
                            <span style="font-size: 12px; color: rgba(255,255,255,0.5);">1 day ago</span>
                        </div>
                        <p style="color: rgba(255,255,255,0.8); font-size: 14px;">
                            Invoice #123 is due in 3 days. Amount: RM 500.00
                        </p>
                    </div>
                </div>
            </div>

            <div class="card" style="cursor: pointer; opacity: 0.7;" onclick="readNotification(3)">
                <div style="display: flex; gap: 16px;">
                    <div style="font-size: 32px;">📚</div>
                    <div style="flex: 1;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <h3 style="font-size: 16px; font-weight: 600;">New IELTS Materials Available</h3>
                            <span style="font-size: 12px; color: rgba(255,255,255,0.5);">3 days ago</span>
                        </div>
                        <p style="color: rgba(255,255,255,0.8); font-size: 14px;">
                            New Speaking module practice tests have been added to your materials
                        </p>
                    </div>
                </div>
            </div>

            <div class="card" style="cursor: pointer; opacity: 0.7;" onclick="readNotification(4)">
                <div style="display: flex; gap: 16px;">
                    <div style="font-size: 32px;">✅</div>
                    <div style="flex: 1;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <h3 style="font-size: 16px; font-weight: 600;">Document Approved</h3>
                            <span style="font-size: 12px; color: rgba(255,255,255,0.5);">5 days ago</span>
                        </div>
                        <p style="color: rgba(255,255,255,0.8); font-size: 14px;">
                            Your passport copy has been verified and approved
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Notification Modal -->
    <div id="notif-modal" class="modal-overlay" onclick="closeNotifModal(event)">
        <div class="modal-content glass-card">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px;">
                <div style="display: flex; gap: 16px; align-items: center;">
                    <div id="modal-icon" style="font-size: 40px;">🔔</div>
                    <div>
                        <h2 id="modal-title" style="font-size: 20px; font-weight: 600; color: white;">Notification</h2>
                        <span id="modal-date" style="font-size: 14px; color: rgba(255,255,255,0.6);"></span>
                    </div>
                </div>
                <button onclick="closeNotifModal(null)"
                    style="background:none; border:none; color:white; font-size: 24px; cursor: pointer;">&times;</button>
            </div>

            <div id="modal-body"
                style="font-size: 16px; line-height: 1.6; color: rgba(255,255,255,0.9); margin-bottom: 32px;">
                <!-- Content here -->
            </div>

            <div style="text-align: right;">
                <button class="btn btn-secondary" onclick="closeNotifModal(null)">Close</button>
            </div>
        </div>
    </div>

    <script src="layout.js"></script>
    <script>
        const auth = checkAuth();
        if (auth) {
            const studentName = auth.payload.full_name || 'Student';
            document.getElementById('student-name').textContent = studentName;
            document.getElementById('profile-avatar').textContent = studentName.charAt(0).toUpperCase();
        }

        let allNotifications = [];

        async function loadNotifications() {
            try {
                const auth = checkAuth();
                if (!auth) return;

                const studentName = auth.payload.full_name || 'Student';
                document.getElementById('student-name').textContent = studentName;
                document.getElementById('profile-avatar').textContent = studentName.charAt(0).toUpperCase();

                const response = await fetch('/api/notifications/my', {
                    headers: { 'Authorization': `Bearer ${auth.token}` }
                });

                if (response.ok) {
                    allNotifications = await response.json();
                    renderNotifications(allNotifications);
                } else {
                    console.error("Failed to load notifications");
                    renderEmpty("Failed to load notifications");
                }
            } catch (error) {
                console.error("Error:", error);
                renderEmpty("Error loading notifications");
            }
        }

        function renderNotifications(notifs) {
            const container = document.getElementById('notifications-container');

            if (notifs.length === 0) {
                renderEmpty("No notifications yet");
                return;
            }

            container.innerHTML = notifs.map(n => `
                <div class="card notif-card" 
                    id="notif-${n.id}"
                    style="${n.is_read ? 'opacity: 0.7;' : 'background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3B82F6;'}"
                    onclick="openNotifModal(${n.id})">
                    <div style="display: flex; gap: 16px;">
                        <div style="font-size: 32px;">${getIcon(n.message)}</div>
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; align-items: start;">
                                <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 4px;">${getTitle(n.message)}</h3>
                                <div style="text-align: right;">
                                    <span style="font-size: 12px; color: rgba(255,255,255,0.5);">
                                        ${new Date(n.created_at).toLocaleString()}
                                    </span>
                                    ${!n.is_read ? '<div style="font-size: 10px; color: var(--student-primary); margin-top: 4px;">UNREAD</div>' : ''}
                                </div>
                            </div>
                            <p class="notif-message" style="color: rgba(255,255,255,0.7); font-size: 14px;">
                                ${n.message}
                            </p>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openNotifModal(id) {
            const n = allNotifications.find(item => item.id == id);
            if (!n) return;

            const modal = document.getElementById('notif-modal');
            const title = document.getElementById('modal-title');
            const date = document.getElementById('modal-date');
            const body = document.getElementById('modal-body');
            const icon = document.getElementById('modal-icon');

            title.textContent = getTitle(n.message);
            date.textContent = new Date(n.created_at).toLocaleString();
            body.textContent = n.message;
            icon.textContent = getIcon(n.message);

            modal.classList.add('active');

            if (!n.is_read) {
                markAsRead(n.id);
                n.is_read = 1;
                // Update UI of the card behind
                const card = document.getElementById(`notif-${n.id}`);
                if (card) {
                    card.style.opacity = '0.7';
                    card.style.background = ''; // Revert to glass
                    card.style.borderLeft = '';
                    // Remove UNREAD badge if possible, but innerHTML replace is easiest or just leave it until reload
                }
            }
        }

        function closeNotifModal(e) {
            if (e && e.target !== e.currentTarget) return;
            document.getElementById('notif-modal').classList.remove('active');
        }

        function renderEmpty(msg) {
            document.getElementById('notifications-container').innerHTML = `
                <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.5);">
                    <div style="font-size: 48px; margin-bottom: 16px;">🔕</div>
                    <p>${msg}</p>
                </div>
            `;
        }

        async function markAsRead(id) {
            try {
                const auth = checkAuth();
                await fetch(`/api/notifications/my/${id}/read`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${auth.token}` }
                });
                // We don't reload list to avoid closing the accordion
            } catch (e) {
                console.error("Error marking as read", e);
            }
        }

        async function markAllRead() {
            try {
                const auth = checkAuth();
                const res = await fetch('/api/notifications/my/read-all', {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${auth.token}` }
                });

                if (res.ok) {
                    showToast("All notifications marked as read", "success");
                    loadNotifications();
                } else {
                    showToast("Failed to mark all as read", "error");
                }
            } catch (e) {
                console.error(e);
                showToast("Error", "error");
            }
        }

        function getIcon(msg) {
            msg = msg.toLowerCase();
            if (msg.includes('document')) return '✅';
            if (msg.includes('invoice') || msg.includes('payment')) return '💰';
            if (msg.includes('ielts')) return '📚';
            if (msg.includes('application')) return '📝';
            return '🔔';
        }

        function getTitle(msg) {
            msg = msg.toLowerCase();
            if (msg.includes('verified')) return 'Document Verified';
            if (msg.includes('invoice')) return 'Invoice Update';
            if (msg.includes('ielts')) return 'IELTS Update';
            if (msg.includes('application')) return 'Application Update';
            return 'Notification';
        }

        function filterNotifs(type) {
            if (type === 'all') return renderNotifications(allNotifications);

            if (type === 'unread') {
                renderNotifications(allNotifications.filter(n => !n.is_read));
                return;
            }

            const keywords = {
                'applications': ['application'],
                'payments': ['invoice', 'payment'],
                'ielts': ['ielts']
            };

            const keyword = keywords[type];
            if (keyword) {
                renderNotifications(allNotifications.filter(n =>
                    keyword.some(k => n.message.toLowerCase().includes(k))
                ));
            }
        }

        loadNotifications();
    </script>
</body>

</html>